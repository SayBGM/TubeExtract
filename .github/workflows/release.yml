name: release

on:
  push:
    tags:
      - "v*"

jobs:
  build:
    strategy:
      fail-fast: false
      matrix:
        platform: [macos-latest, windows-latest]
    runs-on: ${{ matrix.platform }}
    permissions:
      contents: write
    env:
      RELEASE_VERSION: ${{ github.ref_name }}
    steps:
      - uses: actions/checkout@v4

      - name: Setup Node
        uses: actions/setup-node@v4
        with:
          node-version: 20
          cache: npm

      - name: Setup Rust
        uses: dtolnay/rust-toolchain@stable

      - name: Install frontend dependencies
        run: npm ci

      - name: Sync app version from tag
        shell: bash
        run: |
          node <<'NODE'
          const fs = require('fs');
          const raw = process.env.RELEASE_VERSION || '';
          const version = raw.replace(/^v/, '').trim();
          if (!version || version === 'undefined' || version === 'null') {
            throw new Error(`Invalid RELEASE_VERSION: "${raw}"`);
          }

          const files = ['package.json', 'src-tauri/tauri.conf.json'];
          for (const file of files) {
            const json = JSON.parse(fs.readFileSync(file, 'utf8'));
            json.version = version;
            fs.writeFileSync(file, JSON.stringify(json, null, 2) + '\n');
          }
          NODE

      - name: Validate Cargo.toml
        shell: bash
        run: |
          set -euo pipefail
          grep -nE '^version\s*=\s*"[^"]+"' src-tauri/Cargo.toml

      - name: Run unit tests
        run: npm run test

      - name: Ensure resources directory exists
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p src-tauri/resources/bin
          echo "placeholder" > src-tauri/resources/placeholder.txt

      - name: Prepare bundled dependencies (Windows)
        if: runner.os == 'Windows'
        shell: pwsh
        run: |
          $ErrorActionPreference = "Stop"
          New-Item -ItemType Directory -Force -Path "src-tauri/resources/bin" | Out-Null
          Remove-Item -Force -ErrorAction SilentlyContinue "src-tauri/resources/bin/yt-dlp.exe"
          Remove-Item -Force -ErrorAction SilentlyContinue "src-tauri/resources/bin/ffmpeg.exe"
          Remove-Item -Force -ErrorAction SilentlyContinue "src-tauri/resources/bin/ffprobe.exe"

          Invoke-WebRequest -Uri "https://github.com/yt-dlp/yt-dlp/releases/latest/download/yt-dlp.exe" -OutFile "src-tauri/resources/bin/yt-dlp.exe"

          $ffmpegUrls = @(
            "https://github.com/yt-dlp/FFmpeg-Builds/releases/download/latest/ffmpeg-master-latest-win64-gpl.zip",
            "https://www.gyan.dev/ffmpeg/builds/ffmpeg-release-essentials.zip"
          )
          $downloaded = $false
          foreach ($url in $ffmpegUrls) {
            try {
              Invoke-WebRequest -Uri $url -OutFile "ffmpeg-windows.zip"
              $downloaded = $true
              break
            } catch {
              Write-Host "ffmpeg download failed from $url"
            }
          }
          if (-not $downloaded) { throw "failed to download ffmpeg from all mirrors" }

          Expand-Archive -Path "ffmpeg-windows.zip" -DestinationPath "ffmpeg-extract" -Force
          $ffmpeg = Get-ChildItem -Path "ffmpeg-extract" -Recurse -Filter "ffmpeg.exe" | Select-Object -First 1
          $ffprobe = Get-ChildItem -Path "ffmpeg-extract" -Recurse -Filter "ffprobe.exe" | Select-Object -First 1
          if (-not $ffmpeg) { throw "ffmpeg.exe not found in downloaded archive" }
          if (-not $ffprobe) { throw "ffprobe.exe not found in downloaded archive" }
          Copy-Item $ffmpeg.FullName "src-tauri/resources/bin/ffmpeg.exe" -Force
          Copy-Item $ffprobe.FullName "src-tauri/resources/bin/ffprobe.exe" -Force

      - name: Build desktop app (Tauri)
        run: npm run tauri:build

      - name: Prepare release assets (versioned names)
        shell: bash
        run: |
          set -euo pipefail
          mkdir -p release-assets
          while IFS= read -r file; do
            base="$(basename "$file")"
            if [[ "$base" == *.app.tar.gz ]]; then
              stem="${base%.app.tar.gz}"
              tagged="${stem}-${{ github.ref_name }}.app.tar.gz"
            else
              ext="${base##*.}"
              stem="${base%.*}"
              tagged="${stem}-${{ github.ref_name }}.${ext}"
            fi
            cp "$file" "release-assets/$tagged"
          done < <(find src-tauri/target/release/bundle -type f \( -name "*.dmg" -o -name "*.app.tar.gz" -o -name "*.msi" -o -name "*.exe" -o -name "*.zip" \))

      - name: Upload release assets
        uses: softprops/action-gh-release@v2
        with:
          tag_name: ${{ github.ref_name }}
          name: TubeExtract ${{ github.ref_name }}
          body: Automated Tauri release from GitHub Actions.
          draft: false
          prerelease: false
          files: |
            release-assets/*
